<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - æŠ€æœ¯åšå®¢</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <a href="index.html" class="logo">TechBlog</a>
    <div class="nav-links">
        <a href="index.html">é¦–é¡µ</a>
        <a href="publish.html">å‘å¸ƒæ–‡ç« </a>
        <a href="about.html">å…³äº</a>
    </div>
</nav>

<div class="post-detail" id="post">
    <div style="text-align: center; padding: 3rem; color: var(--text-tertiary)">
        <div class="loading"></div>
        <p style="margin-top: 1rem;">åŠ è½½æ–‡ç« ä¸­...</p>
    </div>
</div>

<div class="comments-section">
    <h2>è¯„è®ºåŒº</h2>
    <div id="comments">
        <div style="text-align: center; padding: 2rem; color: var(--text-tertiary)">
            <div class="loading"></div>
            <p style="margin-top: 1rem;">åŠ è½½è¯„è®ºä¸­...</p>
        </div>
    </div>

    <form class="comment-form" id="commentForm">
        <input type="text" name="author" placeholder="ä½ çš„åå­—" required>
        <textarea name="content" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." required></textarea>
        <button type="submit" id="submitComment">æäº¤è¯„è®º</button>
    </form>
</div>

<footer>
    Â© 2025 æŠ€æœ¯åšå®¢ | åŸºäº Supabase + Netlify æ„å»º
</footer>

<script type="module">
    import { supabase } from './supabase.js'

    // è·å–URLä¸­çš„æ–‡ç« ID
    const postId = new URLSearchParams(window.location.search).get('id')
    if (!postId) {
        document.body.innerHTML = `
            <div style="max-width: 800px; margin: 2rem auto; padding: 2rem; text-align: center;">
                <h1>æ–‡ç« ä¸å­˜åœ¨</h1>
                <p style="margin: 1.5rem 0;">æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„æ–‡ç« ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</p>
                <a href="index.html" style="display: inline-block; padding: 0.75rem 1.5rem; background: var(--primary); color: white; text-decoration: none; border-radius: var(--radius-md); transition: background var(--transition-fast);">è¿”å›é¦–é¡µ</a>
            </div>
        `
    }

    // è·å–ä½œè€…åå­—é¦–å­—æ¯ä½œä¸ºå¤´åƒ
    function getInitials(name) {
        return name ? name.charAt(0).toUpperCase() : '?'
    }

    // åŠ è½½æ–‡ç« è¯¦æƒ…ï¼ˆä»æ•°æ®åº“è·å–ï¼‰
    async function loadPost() {
        const { data, error } = await supabase
            .from('posts')
            .select(`
          *,
          categories:category_id (name)
        `)
            .eq('id', postId)
            .single()

        const postContainer = document.getElementById('post')
        
        if (error) {
            console.error('åŠ è½½æ–‡ç« å¤±è´¥ï¼š', error)
            postContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <p style="color: var(--error); font-size: 1.1rem;">æ–‡ç« åŠ è½½å¤±è´¥</p>
                    <a href="index.html" style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--primary); color: white; text-decoration: none; border-radius: var(--radius-md); transition: background var(--transition-fast);">è¿”å›é¦–é¡µ</a>
                </div>
            `
            return
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.title = `${data.title} - æŠ€æœ¯åšå®¢`

        // æ¸²æŸ“æ–‡ç« å†…å®¹
        postContainer.innerHTML = `
            <h1>${data.title}</h1>
            <div class="post-meta">
                <span class="category">${data.categories?.name || 'æœªåˆ†ç±»'}</span>
                <span>ğŸ“… ${new Date(data.created_at).toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}</span>
            </div>
            <div class="post-content">
                <p>${data.content}</p>
            </div>
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                <a href="index.html" style="display: inline-flex; align-items: center; color: var(--primary); text-decoration: none; transition: color var(--transition-fast);">
                    â† è¿”å›æ–‡ç« åˆ—è¡¨
                </a>
            </div>
        `
    }

    // åŠ è½½è¯„è®ºï¼ˆä»æ•°æ®åº“è·å–ï¼‰
    async function loadComments() {
        const { data, error } = await supabase
            .from('comments')
            .select('*')
            .eq('post_id', postId)
            .order('created_at', { ascending: true })

        const commentsDiv = document.getElementById('comments')
        
        if (error) {
            console.error('åŠ è½½è¯„è®ºå¤±è´¥ï¼š', error)
            commentsDiv.innerHTML = `<p style="text-align: center; padding: 2rem; color: var(--error);">è¯„è®ºåŠ è½½å¤±è´¥</p>`
            return
        }

        commentsDiv.innerHTML = '' // æ¸…ç©ºç°æœ‰è¯„è®º

        if (data.length === 0) {
            commentsDiv.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï½</p>'
            return
        }

        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        data.forEach((comment, index) => {
            // åˆ›å»ºè¯„è®ºå…ƒç´ 
            const commentEl = document.createElement('div')
            commentEl.className = 'comment'
            commentEl.style.opacity = '0'
            commentEl.style.transform = 'translateY(10px)'
            commentEl.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${getInitials(comment.author)}</div>
                    <div>
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${new Date(comment.created_at).toLocaleDateString('zh-CN', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</span>
                    </div>
                </div>
                <p>${comment.content}</p>
            `
            commentsDiv.appendChild(commentEl)
            
            // æ·»åŠ æ¸å…¥åŠ¨ç”»ï¼Œæ¯ä¸ªè¯„è®ºå»¶è¿Ÿå‡ºç°
            setTimeout(() => {
                commentEl.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out'
                commentEl.style.opacity = '1'
                commentEl.style.transform = 'translateY(0)'
            }, index * 100)
        })
    }

    // æäº¤è¯„è®ºåˆ°æ•°æ®åº“
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const author = e.target.author.value.trim()
        const content = e.target.content.value.trim()
        const submitBtn = document.getElementById('submitComment')
        
        if (!author || !content) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯')
            return
        }

        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
        submitBtn.disabled = true
        submitBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> æäº¤ä¸­...'

        try {
            // æ’å…¥è¯„è®ºåˆ°æ•°æ®åº“
            const { error } = await supabase
                .from('comments')
                .insert([{
                    post_id: postId,
                    author,
                    content
                }])

            if (error) {
                console.error('æäº¤è¯„è®ºå¤±è´¥ï¼š', error)
                alert('è¯„è®ºæäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
                return
            }

            // é‡ç½®è¡¨å•
            e.target.reset()
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const commentsDiv = document.getElementById('comments')
            const successMsg = document.createElement('div')
            successMsg.style.cssText = `
                text-align: center;
                color: var(--success);
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: rgba(16, 185, 129, 0.1);
                border-radius: var(--radius-md);
                font-weight: 500;
                opacity: 0;
                transform: translateY(-10px);
                transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            `
            successMsg.textContent = 'è¯„è®ºå‘è¡¨æˆåŠŸï¼'
            commentsDiv.insertBefore(successMsg, commentsDiv.firstChild)
            
            setTimeout(() => {
                successMsg.style.opacity = '1'
                successMsg.style.transform = 'translateY(0)'
            }, 10)
            
            // é‡æ–°åŠ è½½è¯„è®º
            setTimeout(() => {
                loadComments()
            }, 500)
            
        } catch (err) {
            console.error('è¯„è®ºå¤„ç†å‡ºé”™ï¼š', err)
            alert('å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•')
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false
            submitBtn.innerHTML = 'æäº¤è¯„è®º'
        }
    })

    // é¡µé¢åŠ è½½åæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        if (postId) {
            loadPost()
            loadComments()
        }
    })
</script>
</body>
</html>