<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布文章 - 技术博客</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <a href="index.html">首页</a>
    <a href="publish.html">发布文章</a>
    <a href="about.html">关于</a>
</nav>

<div class="publish-container">
    <h1>发布技术文章</h1>
    <form id="publishForm" class="comment-form">
        <div>
            <label for="title">文章标题</label>
            <input type="text" id="title" name="title" placeholder="请输入文章标题" required>
        </div>

        <div>
            <label for="category">文章分类</label>
            <select id="category" name="category_id" required>
                <option value="">选择分类</option>
                <!-- 分类会从数据库动态加载 -->
            </select>
        </div>

        <div>
            <label for="content">文章内容</label>
            <textarea id="content" name="content" placeholder="请输入文章内容（支持换行）" rows="10" required></textarea>
        </div>

        <button type="submit">发布文章</button>
    </form>
</div>

<footer>
    © 2025 技术博客 | 基于 Supabase + Netlify 构建
</footer>

<script type="module">
    import { supabase } from './supabase.js'

    // 加载分类列表（从数据库获取）
    async function loadCategories() {
        const { data, error } = await supabase
            .from('categories')
            .select('*')
            .order('name')

        if (error) {
            console.error('加载分类失败：', error)
            return
        }

        const categorySelect = document.getElementById('category')
        data.forEach(category => {
            categorySelect.innerHTML += `
          <option value="${category.id}">${category.name}</option>
        `
        })
    }

    // 提交文章到数据库
    document.getElementById('publishForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const title = e.target.title.value.trim()
        const categoryId = e.target.category_id.value
        const content = e.target.content.value.trim()

        if (!title || !categoryId || !content) {
            alert('请完善文章信息')
            return
        }

        // 插入文章到数据库
        const { error } = await supabase
            .from('posts')
            .insert([{
                title,
                category_id: categoryId,
                content,
                created_at: new Date()
            }])

        if (error) {
            console.error('发布失败：', error)
            alert('发布失败，请重试')
            return
        }

        // 发布成功后跳转到首页
        alert('发布成功！')
        window.location.href = 'index.html'
    })

    // 初始化加载分类
    loadCategories()
</script>
</body>
</html>